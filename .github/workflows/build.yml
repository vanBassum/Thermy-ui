name: Build and Publish Latest Web Bundle

on:
  push:
    branches:
      - main

permissions:
  contents: write  # allow creating/updating release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build gzipped web files
        run: |
          npm run buildgz
          echo "Built files:"
          ls -lh dist

      - name: Create bundle of gz files
        run: |
          cd dist
          tar -czf ../webbundle.tar.gz ./*.gz
          cd ..
          ls -lh webbundle.tar.gz

      - name: Generate manifest.json
        run: |
          HASH=$(sha256sum webbundle.tar.gz | cut -d ' ' -f1)
          COMMIT=$(git rev-parse --short HEAD)
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "{" > manifest.json
          echo "  \"bundle\": \"webbundle.tar.gz\"," >> manifest.json
          echo "  \"sha256\": \"$HASH\"," >> manifest.json
          echo "  \"commit\": \"$COMMIT\"," >> manifest.json
          echo "  \"date\": \"$DATE\"" >> manifest.json
          echo "}" >> manifest.json
          echo "Generated manifest.json:"
          cat manifest.json

      - name: Upload to 'latest' release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Web Bundle
          body: |
            Gzipped web assets bundled for ESP device updates.
            Fetch manifest.json to verify version and integrity.
          files: |
            webbundle.tar.gz
            manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
